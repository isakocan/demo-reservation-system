<!DOCTYPE html>
<html lang="tr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>YTÃœ AkÄ±llÄ± HalÄ± Saha | Demo 3.0</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link rel="stylesheet" href="/static/style.css" />
  </head>
  <body>
    <div id="auth-screen" class="container auth-container">
      <div class="card auth-card">
        <div class="auth-header">
          <img
            src="/static/ytu_logo.png"
            alt="YTÃœ Logo"
            style="height: 60px; margin-bottom: 10px"
          />
          <h4>Spor Tesisleri</h4>
          <p class="mb-0 small opacity-75">Randevu Sistemi</p>
        </div>
        <div class="card-body p-4">
          <div id="login-form">
            <input
              type="email"
              id="login-email"
              class="form-control mb-3"
              placeholder="E-Posta (@std.yildiz.edu.tr)"
            />
            <input
              type="password"
              id="login-pass"
              class="form-control mb-3"
              placeholder="Åžifre"
            />
            <button
              onclick="login()"
              class="btn btn-primary w-100 py-2 fw-bold"
            >
              GiriÅŸ Yap
            </button>
            <div class="text-center mt-3">
              <small class="text-muted">HesabÄ±n yok mu?</small>
              <a
                href="#"
                onclick="toggleAuth()"
                class="text-decoration-none fw-bold"
                >KayÄ±t Ol</a
              >
            </div>
          </div>
          <div id="register-form" class="d-none">
            <div class="row g-2 mb-2">
              <div class="col">
                <input
                  type="text"
                  id="reg-name"
                  class="form-control"
                  placeholder="Ad"
                />
              </div>
              <div class="col">
                <input
                  type="text"
                  id="reg-surname"
                  class="form-control"
                  placeholder="Soyad"
                />
              </div>
            </div>
            <input
              type="text"
              id="reg-student-id"
              class="form-control mb-2"
              placeholder="Ã–ÄŸrenci No"
            />
            <input
              type="email"
              id="reg-email"
              class="form-control mb-2"
              placeholder="Kurumsal E-Posta"
            />
            <input
              type="password"
              id="reg-pass"
              class="form-control mb-3"
              placeholder="Åžifre"
            />
            <button onclick="register()" class="btn btn-success w-100 py-2">
              KaydÄ± Tamamla
            </button>
            <div class="text-center mt-3">
              <a
                href="#"
                onclick="toggleAuth()"
                class="text-decoration-none small"
                >GiriÅŸ'e DÃ¶n</a
              >
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="dashboard" class="d-none">
      <nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom">
        <div class="container-fluid">
          <a class="navbar-brand" href="#">
            <img src="/static/ytu_logo.png" alt="Logo" />
            <span>YTÃœ Spor</span>
          </a>
          <div class="d-flex align-items-center">
            <div class="me-3 text-end d-none d-md-block">
              <div
                id="user-name"
                class="fw-bold text-dark"
                style="font-size: 0.9rem"
              ></div>
              <div
                id="user-role"
                class="badge bg-secondary"
                style="font-size: 0.7rem"
              ></div>
            </div>
            <button
              onclick="location.reload()"
              class="btn btn-outline-danger btn-sm"
            >
              Ã‡Ä±kÄ±ÅŸ
            </button>
          </div>
        </div>
      </nav>

      <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <ul class="nav nav-pills">
            <li class="nav-item">
              <button
                class="nav-link active"
                data-bs-toggle="pill"
                data-bs-target="#tab-calendar"
              >
                <i class="fa-regular fa-calendar-days"></i> Takvim
              </button>
            </li>
            <li class="nav-item">
              <button
                class="nav-link"
                data-bs-toggle="pill"
                data-bs-target="#tab-board"
                onclick="loadBoard()"
              >
                <i class="fa-solid fa-chalkboard-user"></i> Ä°lan Panosu
              </button>
            </li>
          </ul>

          <div class="d-flex gap-2 align-items-center">
            <div class="input-group input-group-sm">
              <span class="input-group-text bg-white"
                ><i class="fa-regular fa-clock"></i> SimÃ¼lasyon:</span
              >
              <input
                type="date"
                id="sim-date"
                class="form-control"
                onchange="renderCalendar()"
              />
            </div>

            <div id="admin-controls" class="d-none">
              <div class="btn-group btn-group-sm">
                <button
                  onclick="setSystemMode('sliding')"
                  class="btn btn-outline-dark active"
                  id="btn-mode-sliding"
                >
                  Kayar
                </button>
                <button
                  onclick="setSystemMode('classic')"
                  class="btn btn-outline-dark"
                  id="btn-mode-classic"
                >
                  Klasik (Pzt)
                </button>
              </div>
            </div>
          </div>
        </div>

        <div class="tab-content">
          <div class="tab-pane fade show active" id="tab-calendar">
            <div class="calendar-card bg-white p-0">
              <div class="row g-0" id="calendar-grid"></div>
            </div>
          </div>

          <div class="tab-pane fade" id="tab-board">
            <div class="row">
              <div class="col-md-4">
                <div class="card shadow-sm border-0 mb-3">
                  <div class="card-header bg-primary text-white">
                    <h6 class="mb-0">
                      <i class="fa-solid fa-plus"></i> Ä°lan Ver
                    </h6>
                  </div>
                  <div class="card-body">
                    <input
                      type="text"
                      id="post-title"
                      class="form-control mb-2"
                      placeholder="BaÅŸlÄ±k (Ã–rn: Kaleci LazÄ±m)"
                    />
                    <textarea
                      id="post-msg"
                      class="form-control mb-2"
                      rows="3"
                      placeholder="MesajÄ±nÄ±z..."
                    ></textarea>
                    <input
                      type="text"
                      id="post-contact"
                      class="form-control mb-3"
                      placeholder="Ä°letiÅŸim (Tel/Insta)"
                    />
                    <button
                      onclick="addPost()"
                      class="btn btn-primary w-100 btn-sm"
                    >
                      YayÄ±nla
                    </button>
                  </div>
                </div>
              </div>
              <div class="col-md-8">
                <div id="board-list" class="row g-3"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="modalReserve" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header bg-success text-white">
            <h5 class="modal-title">Randevu OnayÄ±</h5>
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body text-center">
            <div class="display-6 mb-2">âš½</div>
            <p id="res-detail-text" class="fw-bold"></p>
            <small class="text-muted">Bu saati rezerve etmek Ã¼zeresiniz.</small>
          </div>
          <div class="modal-footer">
            <button onclick="confirmReserve()" class="btn btn-success w-100">
              Onayla
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="modalCancel" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title">Rezervasyon DetayÄ±</h5>
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <div class="alert alert-info">
              <strong>Bu saha sizin!</strong><br />
              Saha No: A-1 <br />
              GiriÅŸ iÃ§in Ã¶ÄŸrenci kimliÄŸinizi gÃ¶steriniz.
            </div>
            <p class="small text-danger">
              * MaÃ§a 24 saatten az kaldÄ±ysa iptal edilemez.
            </p>
          </div>
          <div class="modal-footer">
            <button onclick="cancelReservation()" class="btn btn-danger w-100">
              Ä°ptal Et
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="modalAlarm" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header bg-warning">
            <h5 class="modal-title">ðŸ”” Yer AÃ§Ä±lÄ±rsa Haber Ver</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <p>Åžu an iÃ§in yer yok. Bildirim almak ister misiniz?</p>
            <input type="hidden" id="alarm-type" />
            <button onclick="setAlarm()" class="btn btn-outline-dark w-100">
              <i class="fa-solid fa-bell"></i> Alarm Kur
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="modalAdmin" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header bg-dark text-white">
            <h5 class="modal-title">YÃ¶netici Ä°ÅŸlemi</h5>
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body text-center">
            <button
              onclick="toggleMaintenance()"
              class="btn btn-danger btn-lg w-100"
            >
              <i class="fa-solid fa-power-off"></i> Durumu DeÄŸiÅŸtir (AÃ§/Kapat)
            </button>
          </div>
        </div>
      </div>
    </div>

    <div id="notification-area"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // --- GLOBAL DEÄžÄ°ÅžKENLER ---
      let currentUser = null;
      let currentResId = null; // Ä°ptal iÅŸlemi iÃ§in ID
      let selectedDate = null;
      let selectedSlot = null;

      // Hava Durumu Verileri (SÄ±rasÄ±yla: Pzt, Sal, Ã‡ar, Per, Cum, Cmt, Paz)
      // Not: JS getDay() Pazar=0 dÃ¶ner. Ona gÃ¶re ayarlayacaÄŸÄ±z.
      const weatherIcons = {
        1: { emoji: "ðŸŒ§ï¸", name: "Pzt" },
        2: { emoji: "â›…", name: "Sal" },
        3: { emoji: "â˜€ï¸", name: "Ã‡ar" },
        4: { emoji: "ðŸ’¨", name: "Per" },
        5: { emoji: "â˜ï¸", name: "Cum" },
        6: { emoji: "ðŸŒ©ï¸", name: "Cmt" },
        0: { emoji: "â˜€ï¸", name: "Paz" },
      };

      window.onload = () => {
        document.getElementById("sim-date").valueAsDate = new Date();
        // Polling'i BaÅŸlat (CanlÄ± Bildirim)
        setInterval(checkNotifications, 4000);
      };

      // --- AUTH ---
      function toggleAuth() {
        document.getElementById("login-form").classList.toggle("d-none");
        document.getElementById("register-form").classList.toggle("d-none");
      }

      async function login() {
        const email = document.getElementById("login-email").value;
        const password = document.getElementById("login-pass").value;
        const res = await fetch("/api/login", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email, password }),
        });
        const data = await res.json();
        if (data.success) {
          currentUser = data.user;
          document.getElementById("auth-screen").classList.add("d-none");
          document.getElementById("dashboard").classList.remove("d-none");
          document.getElementById("user-name").innerText =
            currentUser.first_name + " " + currentUser.last_name;
          document.getElementById("user-role").innerText =
            currentUser.role === "admin" ? "YÃ–NETÄ°CÄ°" : "Ã–ÄžRENCÄ°";

          if (currentUser.role === "admin")
            document
              .getElementById("admin-controls")
              .classList.remove("d-none");
          renderCalendar();
        } else {
          alert(data.message);
        }
      }

      async function register() {
        const payload = {
          name: document.getElementById("reg-name").value,
          surname: document.getElementById("reg-surname").value,
          student_id: document.getElementById("reg-student-id").value,
          email: document.getElementById("reg-email").value,
          password: document.getElementById("reg-pass").value,
        };
        const res = await fetch("/api/register", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        const data = await res.json();
        alert(data.message);
        if (data.success) toggleAuth();
      }

      // --- TAKVÄ°M RENDER (EN Ã–NEMLÄ° KISIM) ---
      async function renderCalendar() {
        const dateVal = document.getElementById("sim-date").value;
        const grid = document.getElementById("calendar-grid");
        grid.innerHTML =
          '<div class="text-center p-5 w-100">YÃ¼kleniyor...</div>';

        const res = await fetch(
          `/api/reservations?start_date=${dateVal}&user_id=${currentUser.id}`
        );
        const reservations = await res.json();

        grid.innerHTML = "";
        const startDate = new Date(dateVal);

        // 7 GÃ¼n DÃ¶ngÃ¼sÃ¼
        for (let i = 0; i < 7; i++) {
          let d = new Date(startDate);
          d.setDate(startDate.getDate() + i);
          let dateStr = d.toISOString().split("T")[0];
          let dayIdx = d.getDay();
          let wInfo = weatherIcons[dayIdx];

          // SÃ¼tun
          let col = document.createElement("div");
          col.className = "col day-column";

          // Header (Emoji + Ã‡an)
          col.innerHTML = `
                    <div class="day-header">
                        <div class="weather-bg-icon">${wInfo.emoji}</div>
                        <div class="day-title">${wInfo.name}</div>
                        <div class="day-date">${d.getDate()}.${
            d.getMonth() + 1
          }</div>
                        <button class="btn-alarm-header" onclick="openAlarmModal('${dateStr}', null)" title="Bu gÃ¼n iÃ§in alarm kur">
                            <i class="fa-solid fa-bell"></i>
                        </button>
                    </div>
                `;

          // Saatler (12:00 - 24:00)
          for (let h = 12; h < 24; h++) {
            // Bu saatte kayÄ±t var mÄ±?
            let booking = reservations.find(
              (r) => r.reservation_date === dateStr && r.time_slot === h
            );

            let slotDiv = document.createElement("div");
            let statusClass = "slot-bos";
            let statusText = "BoÅŸ";

            if (booking) {
              if (booking.is_mine) {
                statusClass = "slot-sizin";
                statusText = booking.display_name; // "SÄ°ZÄ°N"
              } else if (booking.status === "maintenance") {
                statusClass = "slot-bakim";
                statusText = "BAKIMDA";
              } else {
                statusClass = "slot-dolu";
                statusText = booking.display_name; // "DOLU"
              }
            }

            slotDiv.className = `time-slot ${statusClass}`;
            slotDiv.innerHTML = `<strong>${h}:00 - ${
              h + 1
            }:00</strong><span>${statusText}</span>`;

            // TÄ±klama OlaylarÄ±
            slotDiv.onclick = () => handleSlotClick(dateStr, h, booking);
            col.appendChild(slotDiv);
          }
          grid.appendChild(col);
        }
      }

      // --- TIKLAMA YÃ–NETÄ°CÄ°SÄ° ---
      function handleSlotClick(date, slot, booking) {
        selectedDate = date;
        selectedSlot = slot;

        if (currentUser.role === "admin") {
          new bootstrap.Modal(document.getElementById("modalAdmin")).show();
          return;
        }

        if (booking) {
          if (booking.is_mine) {
            // Kendi randevusu -> Ä°ptal EkranÄ±
            currentResId = booking.id;
            new bootstrap.Modal(document.getElementById("modalCancel")).show();
          } else if (booking.status === "active") {
            // BaÅŸkasÄ±nÄ±n -> Alarm EkranÄ±
            openAlarmModal(date, slot);
          }
          // BakÄ±mdaysa hiÃ§bir ÅŸey yapma
        } else {
          // BoÅŸ -> Randevu Al
          document.getElementById(
            "res-detail-text"
          ).innerText = `${date} | ${slot}:00`;
          new bootstrap.Modal(document.getElementById("modalReserve")).show();
        }
      }

      // --- Ä°ÅžLEM FONKSÄ°YONLARI ---
      async function confirmReserve() {
        const res = await fetch("/api/reserve", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            user_id: currentUser.id,
            date: selectedDate,
            time_slot: selectedSlot,
          }),
        });
        const data = await res.json();
        bootstrap.Modal.getInstance(
          document.getElementById("modalReserve")
        ).hide();
        alert(data.message);
        if (data.success) renderCalendar();
      }

      async function cancelReservation() {
        const res = await fetch("/api/cancel", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            reservation_id: currentResId,
            simulation_date: document.getElementById("sim-date").value,
          }),
        });
        const data = await res.json();
        bootstrap.Modal.getInstance(
          document.getElementById("modalCancel")
        ).hide();
        alert(data.message);
        if (data.success) renderCalendar();
      }

      function openAlarmModal(date, slot) {
        selectedDate = date;
        selectedSlot = slot; // null ise tÃ¼m gÃ¼n demektir
        new bootstrap.Modal(document.getElementById("modalAlarm")).show();
      }

      async function setAlarm() {
        const res = await fetch("/api/alarm", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            user_id: currentUser.id,
            date: selectedDate,
            time_slot: selectedSlot,
          }),
        });
        const data = await res.json();
        bootstrap.Modal.getInstance(
          document.getElementById("modalAlarm")
        ).hide();
        alert(data.message);
      }

      async function toggleMaintenance() {
        await fetch("/api/maintenance", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            user_id: currentUser.id,
            date: selectedDate,
            time_slot: selectedSlot,
          }),
        });
        bootstrap.Modal.getInstance(
          document.getElementById("modalAdmin")
        ).hide();
        renderCalendar();
      }

      // --- Ä°LAN PANOSU ---
      async function loadBoard() {
        const res = await fetch("/api/board");
        const posts = await res.json();
        const list = document.getElementById("board-list");
        list.innerHTML = "";
        posts.forEach((p) => {
          list.innerHTML += `
                    <div class="col-12">
                        <div class="card bulletin-card p-3 shadow-sm">
                            <h6 class="fw-bold mb-1">${p.title}</h6>
                            <p class="mb-2 text-dark">${p.message}</p>
                            <div class="bulletin-info d-flex justify-content-between">
                                <span><i class="fa-solid fa-user"></i> ${p.first_name} ${p.last_name[0]}.</span>
                                <span><i class="fa-solid fa-phone"></i> ${p.contact_info}</span>
                            </div>
                        </div>
                    </div>
                `;
        });
      }

      async function addPost() {
        await fetch("/api/board", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            user_id: currentUser.id,
            title: document.getElementById("post-title").value,
            message: document.getElementById("post-msg").value,
            contact: document.getElementById("post-contact").value,
          }),
        });
        document.getElementById("post-msg").value = "";
        loadBoard();
      }

      // --- SÄ°STEM AYARLARI (ADMIN) ---
      async function setSystemMode(mode) {
        await fetch("/api/settings", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ mode }),
        });
        document
          .getElementById("btn-mode-sliding")
          .classList.toggle("active", mode === "sliding");
        document
          .getElementById("btn-mode-classic")
          .classList.toggle("active", mode === "classic");
        renderCalendar();
      }

      // --- CANLI BÄ°LDÄ°RÄ°M (POLLING) ---
      async function checkNotifications() {
        if (!currentUser) return;
        try {
          const res = await fetch(
            `/api/notifications?user_id=${currentUser.id}`
          );
          const alerts = await res.json();

          alerts.forEach((a) => {
            showToast(
              `MÃœJDE! ${a.date} tarihindeki ${a.slot} alarmÄ±nÄ±z iÃ§in yer aÃ§Ä±ldÄ±!`
            );
          });
        } catch (e) {}
      }

      function showToast(msg) {
        const area = document.getElementById("notification-area");
        const toast = document.createElement("div");
        toast.className = "toast-custom";
        toast.innerHTML = `<i class="fa-solid fa-bell me-2"></i> ${msg}`;
        area.appendChild(toast);
        setTimeout(() => toast.remove(), 6000);
      }
    </script>
  </body>
</html>
